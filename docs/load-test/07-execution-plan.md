# 7. 실행 계획

> **[← 이전: 인프라 구성](06-infrastructure.md)** | **[메인으로 돌아가기](README.md)** | **[다음: 모니터링 및 분석 →](08-monitoring.md)**

## 7.1 부하 테스트 시나리오

### 🚀 35분 부하테스트 전체 플로우

```
총 실행 시간: 35분
목표 사용자: 86 VU (평상시) → 258 VU (피크)
시나리오 분배: A(50%) + B(50%)

┌─────────────┬─────────────┬─────────┬─────────────┐
│   Phase 1   │   Phase 2   │ Phase 3 │   Phase 4   │
│  Ramp-up    │   Peak 1    │  Spike  │   Peak 2    │
│   (10분)    │   (10분)    │  (5분)  │   (10분)    │
└─────────────┴─────────────┴─────────┴─────────────┘
0 → 86 VU     86 VU 유지    258 VU    86 VU 복귀
```

### Phase별 상세 시나리오

#### Phase 1: Ramp-up (10분) - 점진적 부하 증가
- **목표**: 시스템의 기본 성능 확인 및 안정적인 부하 증가
- **시나리오 A**: 0 → 43 VU (컨텐츠 생성형 사용자)
- **시나리오 B**: 0 → 43 VU (컨텐츠 소비형 사용자)
- **증가 패턴**: 1분마다 8-9 VU씩 선형 증가
- **성공 기준**: 
  - 에러율 < 0.1%
  - 평균 응답시간 < 500ms
  - CPU 사용률 < 70%

#### Phase 2: Peak 1 (10분) - 목표 부하 안정화
- **목표**: 설계된 목표 부하에서의 시스템 안정성 검증
- **총 VU**: 86명 (43 + 43)
- **부하 패턴**: 일정한 86 VU 유지
- **주요 검증 사항**:
  - 장시간 안정성 확인
  - 메모리 누수 여부 점검
  - DB Connection Pool 상태 모니터링
- **성공 기준**:
  - 모든 목표 성능 지표 달성
  - 시스템 리소스 안정적 유지

#### Phase 3: Spike (5분) - 급격한 부하 증가
- **목표**: 트래픽 급증 상황에서의 시스템 대응 능력 검증
- **부하 증가**: 86 VU → 258 VU (3배 증가)
- **증가 방식**: 1분 내 급격한 증가
- **시나리오별 분배**:
  - 시나리오 A: 43 → 129 VU
  - 시나리오 B: 43 → 129 VU
- **성공 기준**:
  - 에러율 < 1% (완화된 기준)
  - 시스템 다운 없음
  - 복구 시간 < 30초

#### Phase 4: Peak 2 (10분) - 복구 및 재안정화
- **목표**: 높은 부하 이후 시스템 복구 능력 검증
- **부하 감소**: 258 VU → 86 VU
- **감소 방식**: 2분에 걸쳐 점진적 감소
- **검증 사항**:
  - 시스템 정상 상태 복귀
  - 성능 지표 원상 복구
  - 에러 로그 정리 상태
- **성공 기준**:
  - Phase 2와 동일한 성능 지표 달성
  - 누적 에러 없음

---

## 7.2 실행 체크리스트

### 🔍 테스트 실행 전 준비사항

#### A. 테스트 데이터 검증
- [ ] **사용자 데이터 검증**
  - [ ] 6,000명 테스트 사용자 생성 완료
  - [ ] 인증 토큰 발급 테스트 성공
  - [ ] 사용자별 권한 설정 확인
- [ ] **리캡 데이터 검증**
  - [ ] 기존 리캡 결과 데이터 존재 확인
  - [ ] 오디오 파일 S3 업로드 완료
  - [ ] 시나리오 B 테스트용 데이터 준비 완료
- [ ] **스토리보드 데이터 검증**
  - [ ] 8개 스토리보드 Scene 체인 무결성 확인
  - [ ] nextSceneId 연결 구조 검증
  - [ ] Scene 타입별 content 필드 확인

#### B. API 서버 헬스체크
- [ ] **기본 상태 확인**
  ```bash
  curl -f http://api-server/health
  curl -f http://api-server/api/v0/auth/callback/test?code=test_user_1
  ```
- [ ] **데이터베이스 연결 확인**
  - [ ] Connection Pool 설정 적용 (최대 50개)
  - [ ] 테스트 쿼리 실행 성공
  - [ ] 인덱스 최적화 상태 점검
- [ ] **애플리케이션 설정 확인**
  - [ ] loadtest 프로파일 활성화
  - [ ] TestAuthService 정상 동작
  - [ ] JWT 토큰 만료 시간 설정 확인

#### C. 모니터링 대시보드 준비
- [ ] **CloudWatch 대시보드 설정**
  - [ ] EC2 메트릭 (CPU, Memory, Network)
  - [ ] RDS 메트릭 (Connections, CPU, IOPS)
  - [ ] S3 메트릭 (Requests, Bandwidth)
- [ ] **nGrinder 모니터링 준비**
  - [ ] Controller 웹 인터페이스 접속 확인
  - [ ] Agent 상태 점검 (3-5개 Agent 연결)
  - [ ] 테스트 결과 저장 공간 확보
- [ ] **알람 설정 활성화**
  - [ ] 임계값 초과 시 SNS 알림
  - [ ] 긴급 연락망 확인

#### D. 네트워크 대역폭 확인
- [ ] **대역폭 측정**
  - [ ] nGrinder Agent → API 서버 네트워크 속도
  - [ ] API 서버 → RDS 연결 지연시간
  - [ ] S3 업로드/다운로드 속도 측정
- [ ] **보안그룹 설정 확인**
  - [ ] 필요한 포트 개방 (80, 443, 5432)
  - [ ] 방화벽 규칙 점검
  - [ ] SSL/TLS 인증서 유효성 확인

#### E. 로그 수집 설정
- [ ] **로그 수집 경로 설정**
  - [ ] Application Logs → CloudWatch Logs
  - [ ] Access Logs → S3
  - [ ] Error Logs → CloudWatch Logs Insights
- [ ] **로그 보존 정책 설정**
  - [ ] 7일 보존 기간 설정
  - [ ] 자동 아카이브 스크립트 준비
- [ ] **실시간 로그 모니터링 준비**
  - [ ] 에러 패턴 감지 설정
  - [ ] 성능 저하 패턴 모니터링

---

## 7.3 테스트 실행 절차

### 🎬 단계별 실행 가이드

#### Step 1: 사전 점검 (5분)
```bash
# 환경 점검 스크립트 실행
./scripts/pre-test-check.sh

# 주요 확인 사항
✅ API 서버 응답 정상
✅ 데이터베이스 연결 성공
✅ S3 접근 권한 확인
✅ nGrinder Controller 연결
✅ 모니터링 대시보드 활성화
```

#### Step 2: nGrinder 테스트 설정 (10분)
1. **스크립트 업로드**
   - [ ] UserScenarioA.groovy 업로드
   - [ ] UserScenarioB.groovy 업로드
   - [ ] MasterScenario.groovy 업로드
   - [ ] 라이브러리 파일들 (lib/) 업로드

2. **테스트 설정**
   - [ ] 총 실행 시간: 35분
   - [ ] Agent 수: 3-5개
   - [ ] Ramp-up: 10분
   - [ ] 최대 VU: 258명
   - [ ] 테스트 이름: "ORV-API-LoadTest-YYYYMMDD-HHMM"

3. **검증 테스트 (5분)**
   - [ ] 10 VU로 파일럿 테스트 실행
   - [ ] 기본 기능 동작 확인
   - [ ] 에러 없음 확인

#### Step 3: 본 테스트 실행 (35분)
```bash
# 테스트 시작 시간 기록
echo "$(date): 부하테스트 시작" >> test-execution.log

# 실시간 모니터링 시작
./scripts/real-time-monitor.sh &

# nGrinder 테스트 실행 (웹 인터페이스)
# Phase별 진행 상황 모니터링
```

#### Step 4: 실시간 모니터링 (35분간)
- **Phase 1 (0-10분)**: 점진적 증가 모니터링
  - [ ] VU 증가 패턴 정상 여부
  - [ ] 응답시간 안정성 확인
  - [ ] 에러 발생 여부 체크

- **Phase 2 (10-20분)**: 안정화 구간 모니터링
  - [ ] 86 VU 일정 유지 확인
  - [ ] 시스템 리소스 사용량 추이
  - [ ] DB Connection Pool 상태

- **Phase 3 (20-25분)**: 스파이크 구간 집중 모니터링
  - [ ] 258 VU 급증 시 시스템 반응
  - [ ] 에러율 급증 여부 모니터링
  - [ ] 응답시간 변화 추이

- **Phase 4 (25-35분)**: 복구 구간 모니터링
  - [ ] 86 VU 복귀 후 안정화
  - [ ] 시스템 정상 상태 복구 확인
  - [ ] 누적 에러 정리 상태

#### Step 5: 테스트 완료 및 정리 (10분)
```bash
# 테스트 완료 시간 기록
echo "$(date): 부하테스트 완료" >> test-execution.log

# 즉시 결과 수집
./scripts/collect-results.sh

# 환경 정리
./scripts/post-test-cleanup.sh

# 긴급 알람 해제
./scripts/disable-test-alarms.sh
```

---

## 7.4 중단 기준 및 비상 계획

### 🚨 테스트 중단 기준

| 중단 기준 | 임계값 | 지속 시간 | 조치 |
|-----------|--------|-----------|------|
| **시스템 다운** | 응답 불가 | 30초 | 즉시 중단 |
| **높은 에러율** | > 5% | 2분 | 점진적 중단 |
| **극심한 지연** | 평균 > 10초 | 3분 | VU 감소 후 중단 |
| **DB 연결 실패** | > 50% 실패 | 1분 | 즉시 중단 |
| **메모리 부족** | > 95% 사용 | 1분 | 점진적 중단 |

### 🔧 비상 조치 절차

#### 긴급 중단 시나리오
1. **즉시 중단 (Emergency Stop)**
   ```bash
   # nGrinder 테스트 강제 중단
   # API 서버 상태 확인
   # 시스템 복구 작업 시작
   ./scripts/emergency-stop.sh
   ```

2. **점진적 중단 (Graceful Stop)**
   ```bash
   # VUser 수 단계적 감소
   # 진행중인 요청 완료 대기
   # 안전한 테스트 종료
   ./scripts/graceful-stop.sh
   ```

#### 복구 절차
- [ ] **시스템 상태 진단**
  - [ ] 로그 분석으로 원인 파악
  - [ ] 리소스 사용량 점검
  - [ ] 데이터 무결성 확인
- [ ] **복구 작업 수행**
  - [ ] 애플리케이션 재시작
  - [ ] DB Connection Pool 리셋
  - [ ] 캐시 정리
- [ ] **재테스트 계획 수립**
  - [ ] 문제점 분석 및 개선
  - [ ] 테스트 시나리오 조정
  - [ ] 재실행 일정 협의

---

## 7.5 실행 후 체크리스트

### ✅ 테스트 완료 직후 (30분 내)

#### A. 즉시 확인 사항
- [ ] **시스템 정상 상태 확인**
  - [ ] API 서버 정상 응답 여부
  - [ ] 데이터베이스 연결 상태
  - [ ] 애플리케이션 로그 에러 여부
- [ ] **결과 데이터 수집**
  - [ ] nGrinder 테스트 리포트 다운로드
  - [ ] CloudWatch 메트릭 데이터 추출
  - [ ] 로그 파일 백업
- [ ] **환경 정리**
  - [ ] 테스트 데이터 정리 실행
  - [ ] 임시 파일 삭제
  - [ ] 알람 설정 원복

#### B. 초기 분석 (1시간 내)
- [ ] **성능 지표 요약**
  - [ ] 평균/최대 TPS
  - [ ] 응답시간 분포 (95%, 99%)
  - [ ] 에러율 및 에러 패턴
- [ ] **리소스 사용량 분석**
  - [ ] CPU/Memory 최대 사용률
  - [ ] DB Connection 최대 사용 수
  - [ ] 네트워크 대역폭 사용량
- [ ] **주요 이슈 식별**
  - [ ] 병목 지점 파악
  - [ ] 예상치 못한 에러 분석
  - [ ] 성능 목표 달성 여부 평가

## 📋 관련 문서

- **이전 단계**: [인프라 구성](06-infrastructure.md)에서 환경 설정 및 체크리스트 확인
- **다음 단계**: [모니터링 및 분석](08-monitoring.md)에서 상세 분석 방법 확인
- **참조**: [성능 목표](03-performance-targets.md)에서 성공 기준 재확인

---

**[← 이전: 인프라 구성](06-infrastructure.md)** | **[메인으로 돌아가기](README.md)** | **[다음: 모니터링 및 분석 →](08-monitoring.md)**
